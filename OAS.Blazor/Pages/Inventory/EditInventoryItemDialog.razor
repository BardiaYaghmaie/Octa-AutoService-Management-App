@using OAS.Application.DomainModels;
@using OAS.Application.Features.Inventory.GetInventoryItems;
@using OAS.Application.Features.InventoryFeatures.AddInventoryItem;
@using OAS.Application.Features.InventoryFeatures.UpdateInventoryItem;
@using OAS.Application.Features.InvoiceFeatures.CreateBuyInvoice;
@using Variant = Radzen.Variant
@using AlignItems = Radzen.AlignItems
@inject MediatR.IMediator mediator;
@inject NavigationManager navigationManager;
@using OAS.Application.DomainModels;
@using OAS.Application.Features.CustomerFeatures.AddCustomer;
@using OAS.Application.Features.InventoryFeatures.AddService;
@using OAS.Application.Features.InventoryFeatures.UpdateService;
@inject Radzen.DialogService dialogService
<MudRTLProvider RightToLeft="true">
    <RadzenRow>
        <!-- sabte aghlame kharid-->
            <RadzenTemplateForm TItem="AddNewInvoiceInventoryItemModel" Data="addNewInvoiceInventoryItemModel" Submit="OnSubmitAddNewInvoiceInventoryItem" InvalidSubmit="OnInvalidSubmitAddNewInvoiceInventoryItem">
                <RadzenRow>
                    <RadzenFormField Text="کد کالا" Variant="Variant.Outlined">
                        <RadzenAutoComplete ValueChanged="InventoryCodeItemAutoCompleteTextChanged" Name="Code" Data=@inventoryItems TextProperty="Code" Value="addNewInvoiceInventoryItemModel.Code" Style="width: 13rem" />
                        <RadzenRequiredValidator Component="Code" Text="کد کالا را وارد کنید" Popup=@popup Style="position: absolute;top:40px" />
                    </RadzenFormField>
                    
                    <RadzenButton Click=@(args => OnClick("Primary icon button")) Icon="add_circle_outline" Variant="Variant.Outlined" />
                    <RadzenFormField Text="عنوان" Variant="Variant.Outlined">

                        <RadzenAutoComplete ValueChanged="InventoryItemNameAutoCompleteTextChanged" Name="Title" Data=@inventoryItems TextProperty="Title" Value="addNewInvoiceInventoryItemModel.Title" Style="width: 13rem" />
                        <RadzenRequiredValidator Component="Title" Text="عنوان کالا را وارد کنید" Popup=@popup Style="position: absolute;top:40px" />
                    </RadzenFormField>
                </RadzenRow>
                <br />
                <RadzenRow>
                    <RadzenFormField Text="قیمت خرید" Variant="Variant.Outlined">
                        <RadzenTextBox Name="BuyPrice" @bind-Value="@addNewInvoiceInventoryItemModel.BuyPrice" />
                        <RadzenRequiredValidator Component="BuyPrice" Text="قیمت خرید را وارد کنید" Popup=@popup Style="position: absolute;top:40px" />
                    </RadzenFormField>
                    <RadzenFormField Text="قیمت فروش" Variant="Variant.Outlined">
                        <RadzenTextBox Name="SellPrice" @bind-Value="@addNewInvoiceInventoryItemModel.SellPrice" />
                        <RadzenRequiredValidator Component="SellPrice" Text="قیمت فروش را وارد کنید" Popup=@popup Style="position: absolute;top:40px" />
                    </RadzenFormField>
                </RadzenRow>
                <br />

                <RadzenRow Style="border: #6a1a21 solid 2px; padding: 2px;">
                    <RadzenFormField Text="تعداد موجود" Variant="Variant.Outlined">
                        <RadzenTextBox Name="Count" @bind-Value="@addNewInvoiceInventoryItemModel.Count" Disabled="true"/>
                        <RadzenRequiredValidator Component="Count" Text="تعداد  را وارد کنید" Popup=@popup Style="position: absolute;top:40px" />
                    </RadzenFormField>
                    <RadzenFormField Text="حداقل موجودی" Variant="Variant.Outlined">
                        <RadzenTextBox Name="Limit" @bind-Value="@addNewInvoiceInventoryItemModel.Limit" />
                        <RadzenRequiredValidator Component="Limit" Text="حداقل موجودی  را وارد کنید" Popup=@popup Style="position: absolute;top:40px" />
                    </RadzenFormField>
                </RadzenRow>
            </RadzenTemplateForm>
    </RadzenRow>

    

    <RadzenRow JustifyContent="JustifyContent.SpaceEvenly" Style="margin-top:30px">
        <RadzenButton Click="@((args) => dialogService.Close(false))" ButtonStyle="ButtonStyle.Danger" Text="لغو" />
        <RadzenButton ButtonType="Radzen.ButtonType.Submit" ButtonStyle="ButtonStyle.Success" Text="ثبت" />
    </RadzenRow>
    


</MudRTLProvider>
@code {
    bool popup = false;
    string error = "";
    bool createInvoiceButtonDisabled = false;
    private List<InventoryItemDTO> inventoryItems = new();
    private AddNewInventoryItemModel newInventoryItemModel = new();
    private AddNewInvoiceInventoryItemModel addNewInvoiceInventoryItemModel = new();
    private AddNewInvoiceModel addNewInvoiceModel = new();
    private List<CreateBuyInvoice_InventoryItemDTO> invoiceInventoryItems = new();
    private List<GridDataModel> gridData = new();

    class AddNewInvoiceModel
    {
        public string Title { get; set; }
        public string Code { get; set; }
        public DateTime RegisterDate { get; set; }
    }


    class AddNewInventoryItemModel
    {
        public string Title { get; set; }
    }
    class AddNewInvoiceInventoryItemModel
    {
        public Guid Id { get; set; }
        public string Title { get; set; }
        public string Code { get; set; }

        public string BuyPrice { get; set; }
        public string SellPrice { get; set; }
        public string Count { get; set; }
        public string Limit { get; set; }
    }
    class GridDataModel
    {
        public Guid InventoryItemId { get; set; }
        public string Title { get; set; }
        public string Code { get; set; }
        public string BuyPrice { get; set; }
        public string SellPrice { get; set; }
    }
    private void OnClickCancel()
    {
        navigationManager.NavigateTo("/inventory");
    }
    private async void OnFinalClick()
    {
        try
        {
            if (invoiceInventoryItems.Count == 0)
            {
                error = "لطفا قسمت ثبت اقلام خرید کالا را انجام دهید";
                return;
            }
            if (string.IsNullOrEmpty(addNewInvoiceModel.Code) || string.IsNullOrEmpty(addNewInvoiceModel.Title) || addNewInvoiceModel.RegisterDate == null)
            {
                error = "لطفا قسمت ثبت فاکتور را انجام دهید";
                return;

            }
            var request = new CreateBuyInvoiceRequest(invoiceInventoryItems, int.Parse(addNewInvoiceModel.Code), addNewInvoiceModel.Title, addNewInvoiceModel.RegisterDate);
            var response = await mediator.Send(request);
            navigationManager.NavigateTo("/invoices");
        }
        catch (Exception e)
        {
            error = "خطا هنگام ثبت نهایی اطلاعات";
        }
    }
    private void OnSubmitAddNewInvoice()
    {
        createInvoiceButtonDisabled = true;
    }
    private void OnInvalidSubmitAddNewInvoice()
    {

    }
    private async Task OnSubmitNewInventoryItem()
    {
        await AddNewInventoryItem();
    }
    private void InventoryItemNameAutoCompleteTextChanged(string newValue)
    {
        addNewInvoiceInventoryItemModel.Title = newValue;
        var inventoryItem = inventoryItems.FirstOrDefault(a => a.Title == newValue);
        if (inventoryItem != null)
        {
            addNewInvoiceInventoryItemModel.Id = inventoryItem.Id;
            addNewInvoiceInventoryItemModel.Code = inventoryItem.Code;
            addNewInvoiceInventoryItemModel.BuyPrice = inventoryItem.BuyPrice.ToString();
            addNewInvoiceInventoryItemModel.SellPrice = inventoryItem.SellPrice.ToString();
            addNewInvoiceInventoryItemModel.Count = inventoryItem.Count.ToString();
            addNewInvoiceInventoryItemModel.Limit = inventoryItem.Limit.ToString();
        }
        else
        {
            addNewInvoiceInventoryItemModel.Id = Guid.Empty;

            addNewInvoiceInventoryItemModel.Code = "";
            addNewInvoiceInventoryItemModel.BuyPrice = "";
            addNewInvoiceInventoryItemModel.SellPrice = "";
            addNewInvoiceInventoryItemModel.Count = "";
            addNewInvoiceInventoryItemModel.Limit = "";
        }

    }
    private void InventoryCodeItemAutoCompleteTextChanged(string newValue)
    {
        addNewInvoiceInventoryItemModel.Code = newValue;
        var inventoryItem = inventoryItems.FirstOrDefault(a => a.Code == newValue);
        if (inventoryItem != null)
        {
            addNewInvoiceInventoryItemModel.Id = inventoryItem.Id;

            addNewInvoiceInventoryItemModel.Title = inventoryItem.Title;
            addNewInvoiceInventoryItemModel.BuyPrice = inventoryItem.BuyPrice.ToString();
            addNewInvoiceInventoryItemModel.SellPrice = inventoryItem.SellPrice.ToString();
            addNewInvoiceInventoryItemModel.Count = inventoryItem.Count.ToString();
            addNewInvoiceInventoryItemModel.Limit = inventoryItem.Limit.ToString();

        }
        else
        {
            addNewInvoiceInventoryItemModel.Id = Guid.Empty;

            addNewInvoiceInventoryItemModel.Title = "";
            addNewInvoiceInventoryItemModel.BuyPrice = "";
            addNewInvoiceInventoryItemModel.SellPrice = "";
            addNewInvoiceInventoryItemModel.Count = "";
            addNewInvoiceInventoryItemModel.Limit = "";
        }
    }
    private async Task FetchInventoryData()
    {
        var request = new GetInventoryItemsRequest();
        var response = await mediator.Send(request);
        inventoryItems = response.InventoryItemDTOs;
    }
    protected override async Task OnInitializedAsync()
    {
        try
        {
            await FetchInventoryData();
        }
        catch (Exception e)
        {
            error = "خطا هنگام خواندن اطلاعات";
        }
    }
    private async Task OnInvalidSubmitNewInventoryItem()
    {

    }
    private async Task OnSubmitAddNewInvoiceInventoryItem()
    {
        AddInvoiceInventoryItem();
    }
    private async Task OnInvalidSubmitAddNewInvoiceInventoryItem()
    {

    }
    private void OnClick(string x)
    {

    }

    private void AddInvoiceInventoryItem()
    {
        try
        {
            if (invoiceInventoryItems.Any(a => a.Id == addNewInvoiceInventoryItemModel.Id))
            {
                throw new Exception("");
            }
            CreateBuyInvoice_InventoryItemDTO dto = new(addNewInvoiceInventoryItemModel.Id, long.Parse(addNewInvoiceInventoryItemModel.BuyPrice), long.Parse(addNewInvoiceInventoryItemModel.SellPrice), float.Parse(addNewInvoiceInventoryItemModel.Count), float.Parse(addNewInvoiceInventoryItemModel.Limit));
            invoiceInventoryItems.Add(dto);
            gridData.Add(new GridDataModel()
                {
                    InventoryItemId = addNewInvoiceInventoryItemModel.Id,
                    Title = addNewInvoiceInventoryItemModel.Title,
                    Code = addNewInvoiceInventoryItemModel.Code,
                    BuyPrice = addNewInvoiceInventoryItemModel.BuyPrice,
                    SellPrice = addNewInvoiceInventoryItemModel.SellPrice
                });
            error = "";
        }
        catch (Exception e)
        {
            error = "لطفا کالای تکراری ثبت نکنید";
        }
    }
    private async Task AddNewInventoryItem()
    {
        try
        {

            var request = new AddInventoryItemRequest(newInventoryItemModel.Title);
            var response = await mediator.Send(request);
            newInventoryItemModel.Title = "";
            await FetchInventoryData();
            //success
        }
        catch (Exception e)
        {
            error = "خطا در حین انجام عملیات";
        }
    }
    private void RemoveInvoiceInventoryItem(Guid inventoryItemId)
    {
        try
        {
            invoiceInventoryItems.Remove(invoiceInventoryItems.First(b => b.Id == inventoryItemId));
            gridData.Remove(gridData.First(b => b.InventoryItemId == inventoryItemId));
        }
        catch (Exception)
        {
            error = "خطا در حین انجام عملیات";
        }
    }
}